{"version":3,"file":"index.js","sources":["../../../src/edge/index.ts"],"sourcesContent":["// import/export got a false positive, and affects most of our index barrel files\n// can be removed once following issue is fixed: https://github.com/import-js/eslint-plugin-import/issues/703\n/* eslint-disable import/export */\nimport { context } from '@opentelemetry/api';\nimport {\n  applySdkMetadata,\n  type EventProcessor,\n  getCapturedScopesOnSpan,\n  getCurrentScope,\n  getGlobalScope,\n  getIsolationScope,\n  getRootSpan,\n  GLOBAL_OBJ,\n  registerSpanErrorInstrumentation,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  setCapturedScopesOnSpan,\n  spanToJSON,\n  stripUrlQueryAndFragment,\n} from '@sentry/core';\nimport { getScopesFromContext } from '@sentry/opentelemetry';\nimport type { VercelEdgeOptions } from '@sentry/vercel-edge';\nimport { getDefaultIntegrations, init as vercelEdgeInit } from '@sentry/vercel-edge';\nimport { ATTR_NEXT_SPAN_TYPE } from '../common/nextSpanAttributes';\nimport { TRANSACTION_ATTR_SHOULD_DROP_TRANSACTION } from '../common/span-attributes-with-logic-attached';\nimport { addHeadersAsAttributes } from '../common/utils/addHeadersAsAttributes';\nimport { dropMiddlewareTunnelRequests } from '../common/utils/dropMiddlewareTunnelRequests';\nimport { isBuild } from '../common/utils/isBuild';\nimport { flushSafelyWithTimeout, waitUntil } from '../common/utils/responseEnd';\nimport { setUrlProcessingMetadata } from '../common/utils/setUrlProcessingMetadata';\nimport { distDirRewriteFramesIntegration } from './distDirRewriteFramesIntegration';\n\nexport * from '@sentry/vercel-edge';\nexport * from '../common';\nexport { captureUnderscoreErrorException } from '../common/pages-router-instrumentation/_error';\n\n// Override core span methods with Next.js-specific implementations that support Cache Components\nexport { startSpan, startSpanManual, startInactiveSpan } from '../common/utils/nextSpan';\nexport { wrapApiHandlerWithSentry } from './wrapApiHandlerWithSentry';\n\nexport type EdgeOptions = VercelEdgeOptions;\n\nconst globalWithInjectedValues = GLOBAL_OBJ as typeof GLOBAL_OBJ & {\n  _sentryRewriteFramesDistDir?: string;\n  _sentryRelease?: string;\n  _sentryRewritesTunnelPath?: string;\n};\n\n/** Inits the Sentry NextJS SDK on the Edge Runtime. */\nexport function init(options: VercelEdgeOptions = {}): void {\n  registerSpanErrorInstrumentation();\n\n  if (isBuild()) {\n    return;\n  }\n\n  const customDefaultIntegrations = getDefaultIntegrations(options);\n\n  // This value is injected at build time, based on the output directory specified in the build config. Though a default\n  // is set there, we set it here as well, just in case something has gone wrong with the injection.\n  const distDirName = process.env._sentryRewriteFramesDistDir || globalWithInjectedValues._sentryRewriteFramesDistDir;\n\n  if (distDirName) {\n    customDefaultIntegrations.push(distDirRewriteFramesIntegration({ distDirName }));\n  }\n\n  const opts = {\n    defaultIntegrations: customDefaultIntegrations,\n    release: process.env._sentryRelease || globalWithInjectedValues._sentryRelease,\n    ...options,\n  };\n\n  applySdkMetadata(opts, 'nextjs', ['nextjs', 'vercel-edge']);\n\n  const client = vercelEdgeInit(opts);\n\n  client?.on('spanStart', span => {\n    const spanAttributes = spanToJSON(span).data;\n    const rootSpan = getRootSpan(span);\n    const isRootSpan = span === rootSpan;\n\n    dropMiddlewareTunnelRequests(span, spanAttributes);\n\n    // Mark all spans generated by Next.js as 'auto'\n    if (spanAttributes?.['next.span_type'] !== undefined) {\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, 'auto');\n    }\n\n    // Make sure middleware spans get the right op\n    if (spanAttributes?.['next.span_type'] === 'Middleware.execute') {\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_OP, 'http.server.middleware');\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_SOURCE, 'url');\n    }\n\n    // We want to fork the isolation scope for incoming requests\n    if (spanAttributes?.[ATTR_NEXT_SPAN_TYPE] === 'BaseServer.handleRequest' && isRootSpan) {\n      const scopes = getCapturedScopesOnSpan(span);\n\n      const isolationScope = (scopes.isolationScope || getIsolationScope()).clone();\n      const scope = scopes.scope || getCurrentScope();\n\n      const currentScopesPointer = getScopesFromContext(context.active());\n      if (currentScopesPointer) {\n        currentScopesPointer.isolationScope = isolationScope;\n      }\n\n      setCapturedScopesOnSpan(span, scope, isolationScope);\n    }\n\n    if (isRootSpan) {\n      // todo: check if we can set request headers for edge on sdkProcessingMetadata\n      const headers = getIsolationScope().getScopeData().sdkProcessingMetadata?.normalizedRequest?.headers;\n      addHeadersAsAttributes(headers, rootSpan);\n    }\n  });\n\n  // Use the preprocessEvent hook instead of an event processor, so that the users event processors receive the most\n  // up-to-date value, but also so that the logic that detects changes to the transaction names to set the source to\n  // \"custom\", doesn't trigger.\n  client?.on('preprocessEvent', event => {\n    // The otel auto inference will clobber the transaction name because the span has an http.target\n    if (\n      event.type === 'transaction' &&\n      event.contexts?.trace?.data?.['next.span_type'] === 'Middleware.execute' &&\n      event.contexts?.trace?.data?.['next.span_name']\n    ) {\n      if (event.transaction) {\n        // Older nextjs versions pass the full url appended to the middleware name, which results in high cardinality transaction names.\n        // We want to remove the url from the name here.\n        const spanName = event.contexts.trace.data['next.span_name'];\n\n        if (typeof spanName === 'string') {\n          const match = spanName.match(/^middleware (GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS)/);\n          if (match) {\n            const normalizedName = `middleware ${match[1]}`;\n            event.transaction = normalizedName;\n          } else {\n            event.transaction = stripUrlQueryAndFragment(event.contexts.trace.data['next.span_name']);\n          }\n        }\n      }\n    }\n\n    setUrlProcessingMetadata(event);\n  });\n\n  client?.on('spanEnd', span => {\n    if (span === getRootSpan(span)) {\n      waitUntil(flushSafelyWithTimeout());\n    }\n  });\n\n  getGlobalScope().addEventProcessor(\n    Object.assign(\n      (event => {\n        // Filter transactions that we explicitly want to drop.\n        if (event.type === 'transaction') {\n          if (event.contexts?.trace?.data?.[TRANSACTION_ATTR_SHOULD_DROP_TRANSACTION]) {\n            return null;\n          }\n\n          return event;\n        } else {\n          return event;\n        }\n      }) satisfies EventProcessor,\n      { id: 'NextLowQualityTransactionsFilter' },\n    ),\n  );\n\n  try {\n    // @ts-expect-error `process.turbopack` is a magic string that will be replaced by Next.js\n    if (process.turbopack) {\n      getGlobalScope().setTag('turbopack', true);\n    }\n  } catch {\n    // Noop\n    // The statement above can throw because process is not defined on the client\n  }\n}\n\n/**\n * Just a passthrough in case this is imported from the client.\n */\nexport function withSentryConfig<T>(exportedUserNextConfig: T): T {\n  return exportedUserNextConfig;\n}\n"],"names":["vercelEdgeInit"],"mappings":"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"}