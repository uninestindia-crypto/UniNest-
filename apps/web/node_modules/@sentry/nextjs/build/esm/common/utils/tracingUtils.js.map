{"version":3,"file":"tracingUtils.js","sources":["../../../../src/common/utils/tracingUtils.ts"],"sourcesContent":["import { ATTR_HTTP_ROUTE } from '@opentelemetry/semantic-conventions';\nimport type { PropagationContext, Span, SpanAttributes } from '@sentry/core';\nimport {\n  debug,\n  getActiveSpan,\n  getRootSpan,\n  GLOBAL_OBJ,\n  Scope,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  spanToJSON,\n  startNewTrace,\n} from '@sentry/core';\nimport { DEBUG_BUILD } from '../debug-build';\nimport { ATTR_NEXT_SEGMENT, ATTR_NEXT_SPAN_NAME, ATTR_NEXT_SPAN_TYPE } from '../nextSpanAttributes';\nimport { TRANSACTION_ATTR_SHOULD_DROP_TRANSACTION } from '../span-attributes-with-logic-attached';\n\nconst commonPropagationContextMap = new WeakMap<object, PropagationContext>();\n\nconst PAGE_SEGMENT = '__PAGE__';\n\n/**\n * Takes a shared (garbage collectable) object between resources, e.g. a headers object shared between Next.js server components and returns a common propagation context.\n *\n * @param commonObject The shared object.\n * @param propagationContext The propagation context that should be shared between all the resources if no propagation context was registered yet.\n * @returns the shared propagation context.\n */\nexport function commonObjectToPropagationContext(\n  commonObject: unknown,\n  propagationContext: PropagationContext,\n): PropagationContext {\n  if (typeof commonObject === 'object' && commonObject) {\n    const memoPropagationContext = commonPropagationContextMap.get(commonObject);\n    if (memoPropagationContext) {\n      return memoPropagationContext;\n    } else {\n      commonPropagationContextMap.set(commonObject, propagationContext);\n      return propagationContext;\n    }\n  } else {\n    return propagationContext;\n  }\n}\n\nconst commonIsolationScopeMap = new WeakMap<object, Scope>();\n\n/**\n * Takes a shared (garbage collectable) object between resources, e.g. a headers object shared between Next.js server components and returns a common propagation context.\n *\n * @param commonObject The shared object.\n * @param isolationScope The isolationScope that should be shared between all the resources if no isolation scope was created yet.\n * @returns the shared isolation scope.\n */\nexport function commonObjectToIsolationScope(commonObject: unknown): Scope {\n  if (typeof commonObject === 'object' && commonObject) {\n    const memoIsolationScope = commonIsolationScopeMap.get(commonObject);\n    if (memoIsolationScope) {\n      return memoIsolationScope;\n    } else {\n      const newIsolationScope = new Scope();\n      commonIsolationScopeMap.set(commonObject, newIsolationScope);\n      return newIsolationScope;\n    }\n  } else {\n    return new Scope();\n  }\n}\n\ninterface AsyncLocalStorage<T> {\n  getStore(): T | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  run<R, TArgs extends any[]>(store: T, callback: (...args: TArgs) => R, ...args: TArgs): R;\n}\n\nlet nextjsEscapedAsyncStorage: AsyncLocalStorage<true>;\n\n/**\n * Will mark the execution context of the callback as \"escaped\" from Next.js internal tracing by unsetting the active\n * span and propagation context. When an execution passes through this function multiple times, it is a noop after the\n * first time.\n */\nexport function escapeNextjsTracing<T>(cb: () => T): T {\n  const MaybeGlobalAsyncLocalStorage = (GLOBAL_OBJ as { AsyncLocalStorage?: new () => AsyncLocalStorage<true> })\n    .AsyncLocalStorage;\n\n  if (!MaybeGlobalAsyncLocalStorage) {\n    DEBUG_BUILD &&\n      debug.warn(\n        \"Tried to register AsyncLocalStorage async context strategy in a runtime that doesn't support AsyncLocalStorage.\",\n      );\n    return cb();\n  }\n\n  if (!nextjsEscapedAsyncStorage) {\n    nextjsEscapedAsyncStorage = new MaybeGlobalAsyncLocalStorage();\n  }\n\n  if (nextjsEscapedAsyncStorage.getStore()) {\n    return cb();\n  } else {\n    return startNewTrace(() => {\n      return nextjsEscapedAsyncStorage.run(true, () => {\n        return cb();\n      });\n    });\n  }\n}\n\n/**\n * Ideally this function never lands in the develop branch.\n *\n * Drops the entire span tree this function was called in, if it was a span tree created by Next.js.\n */\nexport function dropNextjsRootContext(): void {\n  const nextJsOwnedSpan = getActiveSpan();\n  if (nextJsOwnedSpan) {\n    const rootSpan = getRootSpan(nextJsOwnedSpan);\n    const rootSpanAttributes = spanToJSON(rootSpan).data;\n    if (rootSpanAttributes?.['next.span_type']) {\n      getRootSpan(nextJsOwnedSpan)?.setAttribute(TRANSACTION_ATTR_SHOULD_DROP_TRANSACTION, true);\n    }\n  }\n}\n\n/**\n * Checks if the span is a resolve segment span.\n * @param spanAttributes The attributes of the span to check.\n * @returns True if the span is a resolve segment span, false otherwise.\n */\nexport function isResolveSegmentSpan(spanAttributes: SpanAttributes): boolean {\n  return (\n    spanAttributes[ATTR_NEXT_SPAN_TYPE] === 'NextNodeServer.getLayoutOrPageModule' &&\n    spanAttributes[ATTR_NEXT_SPAN_NAME] === 'resolve segment modules' &&\n    typeof spanAttributes[ATTR_NEXT_SEGMENT] === 'string'\n  );\n}\n\n/**\n * Returns the enhanced name for a resolve segment span.\n * @param segment The segment of the resolve segment span.\n * @param route The route of the resolve segment span.\n * @returns The enhanced name for the resolve segment span.\n */\nexport function getEnhancedResolveSegmentSpanName({ segment, route }: { segment: string; route: string }): string {\n  if (segment === PAGE_SEGMENT) {\n    return `resolve page server component \"${route}\"`;\n  }\n\n  if (segment === '') {\n    return 'resolve root layout server component';\n  }\n\n  return `resolve layout server component \"${segment}\"`;\n}\n\n/**\n * Maybe enhances the span name for a resolve segment span.\n * If the span is not a resolve segment span, this function does nothing.\n * @param activeSpan The active span.\n * @param spanAttributes The attributes of the span to check.\n * @param rootSpanAttributes The attributes of the according root span.\n */\nexport function maybeEnhanceServerComponentSpanName(\n  activeSpan: Span,\n  spanAttributes: SpanAttributes,\n  rootSpanAttributes: SpanAttributes,\n): void {\n  if (!isResolveSegmentSpan(spanAttributes)) {\n    return;\n  }\n\n  const segment = spanAttributes[ATTR_NEXT_SEGMENT] as string;\n  const route = rootSpanAttributes[ATTR_HTTP_ROUTE];\n  const enhancedName = getEnhancedResolveSegmentSpanName({ segment, route: typeof route === 'string' ? route : '' });\n  activeSpan.updateName(enhancedName);\n  activeSpan.setAttributes({\n    'sentry.nextjs.ssr.function.type': segment === PAGE_SEGMENT ? 'Page' : 'Layout',\n    'sentry.nextjs.ssr.function.route': route,\n  });\n  activeSpan.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_OP, 'function.nextjs');\n}\n"],"names":[],"mappings":"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"}