{"version":3,"file":"util.js","sources":["../../../src/config/util.ts"],"sourcesContent":["import { parseSemver } from '@sentry/core';\nimport * as fs from 'fs';\nimport { sync as resolveSync } from 'resolve';\n\n/**\n * Returns the version of Next.js installed in the project, or undefined if it cannot be determined.\n */\nexport function getNextjsVersion(): string | undefined {\n  const nextjsPackageJsonPath = resolveNextjsPackageJson();\n  if (nextjsPackageJsonPath) {\n    try {\n      const nextjsPackageJson: { version: string } = JSON.parse(\n        fs.readFileSync(nextjsPackageJsonPath, { encoding: 'utf-8' }),\n      );\n      return nextjsPackageJson.version;\n    } catch {\n      // noop\n    }\n  }\n\n  return undefined;\n}\n\nfunction resolveNextjsPackageJson(): string | undefined {\n  try {\n    return resolveSync('next/package.json', { basedir: process.cwd() });\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Checks if the current Next.js version supports the runAfterProductionCompile hook.\n * This hook was introduced in Next.js 15.4.1. (https://github.com/vercel/next.js/pull/77345)\n *\n * @param version - version string to check.\n * @returns true if Next.js version is 15.4.1 or higher\n */\nexport function supportsProductionCompileHook(version: string): boolean {\n  const versionToCheck = version;\n  if (!versionToCheck) {\n    return false;\n  }\n\n  const { major, minor, patch } = parseSemver(versionToCheck);\n\n  if (major === undefined || minor === undefined || patch === undefined) {\n    return false;\n  }\n\n  if (major > 15) {\n    return true;\n  }\n\n  // For major version 15, check if it's 15.4.1 or higher\n  if (major === 15) {\n    if (minor > 4) {\n      return true;\n    }\n    if (minor === 4 && patch >= 1) {\n      return true;\n    }\n    return false;\n  }\n\n  return false;\n}\n\n/**\n * Checks if the current Next.js version supports native debug ids for turbopack.\n * This feature was first introduced in Next.js v15.6.0-canary.36 and marked stable in Next.js v16\n *\n * @param version - version string to check.\n * @returns true if Next.js version supports native debug ids for turbopack builds\n */\nexport function supportsNativeDebugIds(version: string): boolean {\n  if (!version) {\n    return false;\n  }\n\n  const { major, minor, prerelease } = parseSemver(version);\n\n  if (major === undefined || minor === undefined) {\n    return false;\n  }\n\n  // Next.js 16+ supports native debug ids\n  if (major >= 16) {\n    return true;\n  }\n\n  // For Next.js 15, check if it's 15.6.0-canary.36+\n  if (major === 15 && prerelease?.startsWith('canary.')) {\n    // Any canary version 15.7+ supports native debug ids\n    if (minor > 6) {\n      return true;\n    }\n\n    // For 15.6 canary versions, check if it's canary.36 or higher\n    if (minor === 6) {\n      const canaryNumber = parseInt(prerelease.split('.')[1] || '0', 10);\n      if (canaryNumber >= 36) {\n        return true;\n      }\n    }\n  }\n\n  return false;\n}\n\n/**\n * Checks if the given Next.js version requires the `experimental.instrumentationHook` option.\n * Next.js 15.0.0 and higher (including certain RC and canary versions) no longer require this option\n * and will print a warning if it is set.\n *\n * @param version - version string to check.\n * @returns true if the version requires the instrumentationHook option to be set\n */\nexport function requiresInstrumentationHook(version: string): boolean {\n  if (!version) {\n    return true; // Default to requiring it if version cannot be determined\n  }\n\n  const { major, minor, patch, prerelease } = parseSemver(version);\n\n  if (major === undefined || minor === undefined || patch === undefined) {\n    return true; // Default to requiring it if parsing fails\n  }\n\n  // Next.js 16+ never requires the hook\n  if (major >= 16) {\n    return false;\n  }\n\n  // Next.js 14 and below always require the hook\n  if (major < 15) {\n    return true;\n  }\n\n  // At this point, we know it's Next.js 15.x.y\n  // Stable releases (15.0.0+) don't require the hook\n  if (!prerelease) {\n    return false;\n  }\n\n  // Next.js 15.x.y with x > 0 or y > 0 don't require the hook\n  if (minor > 0 || patch > 0) {\n    return false;\n  }\n\n  // Check specific prerelease versions that don't require the hook\n  if (prerelease.startsWith('rc.')) {\n    const rcNumber = parseInt(prerelease.split('.')[1] || '0', 10);\n    return rcNumber === 0; // Only rc.0 requires the hook\n  }\n\n  if (prerelease.startsWith('canary.')) {\n    const canaryNumber = parseInt(prerelease.split('.')[1] || '0', 10);\n    return canaryNumber < 124; // canary.124+ doesn't require the hook\n  }\n\n  // All other 15.0.0 prerelease versions (alpha, beta, etc.) require the hook\n  return true;\n}\n\n/**\n * Determines which bundler is actually being used based on environment variables,\n * and CLI flags.\n *\n * @returns 'turbopack' or 'webpack'\n */\nexport function detectActiveBundler(): 'turbopack' | 'webpack' {\n  const turbopackEnv = process.env.TURBOPACK;\n\n  // Check if TURBOPACK env var is set to a truthy value (excluding falsy strings like 'false', '0', '')\n  const isTurbopackEnabled = turbopackEnv && turbopackEnv !== 'false' && turbopackEnv !== '0';\n\n  if (isTurbopackEnabled || process.argv.includes('--turbo')) {\n    return 'turbopack';\n  } else {\n    return 'webpack';\n  }\n}\n"],"names":["resolveSync"],"mappings":";;;;AAIA;AACA;AACA;AACO,SAAS,gBAAgB,GAAuB;AACvD,EAAE,MAAM,qBAAA,GAAwB,wBAAwB,EAAE;AAC1D,EAAE,IAAI,qBAAqB,EAAE;AAC7B,IAAI,IAAI;AACR,MAAM,MAAM,iBAAiB,GAAwB,IAAI,CAAC,KAAK;AAC/D,QAAQ,EAAE,CAAC,YAAY,CAAC,qBAAqB,EAAE,EAAE,QAAQ,EAAE,OAAA,EAAS,CAAC;AACrE,OAAO;AACP,MAAM,OAAO,iBAAiB,CAAC,OAAO;AACtC,IAAI,EAAE,MAAM;AACZ;AACA,IAAI;AACJ,EAAE;;AAEF,EAAE,OAAO,SAAS;AAClB;;AAEA,SAAS,wBAAwB,GAAuB;AACxD,EAAE,IAAI;AACN,IAAI,OAAOA,IAAW,CAAC,mBAAmB,EAAE,EAAE,OAAO,EAAE,OAAO,CAAC,GAAG,EAAC,EAAG,CAAC;AACvE,EAAE,EAAE,MAAM;AACV,IAAI,OAAO,SAAS;AACpB,EAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,6BAA6B,CAAC,OAAO,EAAmB;AACxE,EAAE,MAAM,cAAA,GAAiB,OAAO;AAChC,EAAE,IAAI,CAAC,cAAc,EAAE;AACvB,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF,EAAE,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,KAAA,EAAM,GAAI,WAAW,CAAC,cAAc,CAAC;;AAE7D,EAAE,IAAI,KAAA,KAAU,SAAA,IAAa,KAAA,KAAU,SAAA,IAAa,KAAA,KAAU,SAAS,EAAE;AACzE,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF,EAAE,IAAI,KAAA,GAAQ,EAAE,EAAE;AAClB,IAAI,OAAO,IAAI;AACf,EAAE;;AAEF;AACA,EAAE,IAAI,KAAA,KAAU,EAAE,EAAE;AACpB,IAAI,IAAI,KAAA,GAAQ,CAAC,EAAE;AACnB,MAAM,OAAO,IAAI;AACjB,IAAI;AACJ,IAAI,IAAI,KAAA,KAAU,KAAK,KAAA,IAAS,CAAC,EAAE;AACnC,MAAM,OAAO,IAAI;AACjB,IAAI;AACJ,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF,EAAE,OAAO,KAAK;AACd;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,sBAAsB,CAAC,OAAO,EAAmB;AACjE,EAAE,IAAI,CAAC,OAAO,EAAE;AAChB,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF,EAAE,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,UAAA,EAAW,GAAI,WAAW,CAAC,OAAO,CAAC;;AAE3D,EAAE,IAAI,KAAA,KAAU,aAAa,KAAA,KAAU,SAAS,EAAE;AAClD,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF;AACA,EAAE,IAAI,KAAA,IAAS,EAAE,EAAE;AACnB,IAAI,OAAO,IAAI;AACf,EAAE;;AAEF;AACA,EAAE,IAAI,KAAA,KAAU,EAAA,IAAM,UAAU,EAAE,UAAU,CAAC,SAAS,CAAC,EAAE;AACzD;AACA,IAAI,IAAI,KAAA,GAAQ,CAAC,EAAE;AACnB,MAAM,OAAO,IAAI;AACjB,IAAI;;AAEJ;AACA,IAAI,IAAI,KAAA,KAAU,CAAC,EAAE;AACrB,MAAM,MAAM,YAAA,GAAe,QAAQ,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAA,IAAK,GAAG,EAAE,EAAE,CAAC;AACxE,MAAM,IAAI,YAAA,IAAgB,EAAE,EAAE;AAC9B,QAAQ,OAAO,IAAI;AACnB,MAAM;AACN,IAAI;AACJ,EAAE;;AAEF,EAAE,OAAO,KAAK;AACd;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,2BAA2B,CAAC,OAAO,EAAmB;AACtE,EAAE,IAAI,CAAC,OAAO,EAAE;AAChB,IAAI,OAAO,IAAI,CAAA;AACf,EAAE;;AAEF,EAAE,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,UAAA,EAAW,GAAI,WAAW,CAAC,OAAO,CAAC;;AAElE,EAAE,IAAI,KAAA,KAAU,SAAA,IAAa,KAAA,KAAU,SAAA,IAAa,KAAA,KAAU,SAAS,EAAE;AACzE,IAAI,OAAO,IAAI,CAAA;AACf,EAAE;;AAEF;AACA,EAAE,IAAI,KAAA,IAAS,EAAE,EAAE;AACnB,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF;AACA,EAAE,IAAI,KAAA,GAAQ,EAAE,EAAE;AAClB,IAAI,OAAO,IAAI;AACf,EAAE;;AAEF;AACA;AACA,EAAE,IAAI,CAAC,UAAU,EAAE;AACnB,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF;AACA,EAAE,IAAI,KAAA,GAAQ,KAAK,KAAA,GAAQ,CAAC,EAAE;AAC9B,IAAI,OAAO,KAAK;AAChB,EAAE;;AAEF;AACA,EAAE,IAAI,UAAU,CAAC,UAAU,CAAC,KAAK,CAAC,EAAE;AACpC,IAAI,MAAM,QAAA,GAAW,QAAQ,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAA,IAAK,GAAG,EAAE,EAAE,CAAC;AAClE,IAAI,OAAO,QAAA,KAAa,CAAC,CAAA;AACzB,EAAE;;AAEF,EAAE,IAAI,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE;AACxC,IAAI,MAAM,YAAA,GAAe,QAAQ,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAA,IAAK,GAAG,EAAE,EAAE,CAAC;AACtE,IAAI,OAAO,YAAA,GAAe,GAAG,CAAA;AAC7B,EAAE;;AAEF;AACA,EAAE,OAAO,IAAI;AACb;;AAEA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,mBAAmB,GAA4B;AAC/D,EAAE,MAAM,YAAA,GAAe,OAAO,CAAC,GAAG,CAAC,SAAS;;AAE5C;AACA,EAAE,MAAM,kBAAA,GAAqB,YAAA,IAAgB,YAAA,KAAiB,OAAA,IAAW,YAAA,KAAiB,GAAG;;AAE7F,EAAE,IAAI,kBAAA,IAAsB,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,EAAE;AAC9D,IAAI,OAAO,WAAW;AACtB,EAAE,OAAO;AACT,IAAI,OAAO,SAAS;AACpB,EAAE;AACF;;;;"}